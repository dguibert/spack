modules:
  enable::
    - lmod
  lmod:
    hierarchy:
      - mpi
    hash_length: 0
    core_compilers:
      - 'gcc@7.4.0'
      - 'clang@11.0.1'
    core_specs:
      - 'gcc@7.4.0'
      - 'gcc@10.2.0'
    blacklist:
      - '%gcc@4.8.5'
      - '^python'
      - 'lmod'
      - 'openmpi'
    blacklist_implicits: true
    openmpi-opa:
      environment:
        set:
          OMPI_MCA_pml: 'cm'
    openmpi:
      environment:
        set:
          'OPENMPI_VERSION': '{version}'
    whitelist:
      - 'py-mpi4py'
      - 'py-numpy'
      - 'py-scipy'
      - 'py-h5py'
      - 'py-pyqt5'
      - 'py-jupyter'
      - 'py-torch'
      - 'py-disbatch'
      - 'python-blas-backend^intel-mkl'
      - 'openmpi%gcc'
      # things that depend on python, so they get blocked without a whitelist
      - 'llvm'
      - 'vim'
      - 'gdb'
      - 'cmake'
      - 'mercurial'
      - 'gettext'
      - 'boost'
    all:
      autoload: 'none'
      prerequisites: 'direct'
      environment:
        set:
          '{name}_BASE': '{prefix}'
      suffixes:
        ^mpi: 'mpi'
      filter:
        environment_blacklist: ['CC', 'FC', 'CXX', 'F77']
    matlab:
      environment:
        set:
          'MLM_LICENSE_FILE': '/cm/shared/sw/pkg/vendor/matlab/src/network.lic'
    slurm:
      environment:
        set:
          'CMD_WLM_CLUSTER_NAME': 'slurm'
          'SLURM_CONF': '/cm/shared/apps/slurm/var/etc/slurm/slurm.conf'
    hdf5:
      environment:
        set:
          'HDF5_ROOT': '{prefix}'
    boost:
      environment:
        set:
          'BOOST_ROOT': '{prefix}'
    projections:
      # boost+clanglibcpp+mpi%clang^zlib%gcc@7: '{name}/{version}-libcpp'
      # boost+clanglibcpp+mpi%clang^zlib%gcc@10: '{name}/{version}-libcpp'
      boost+clanglibcpp%clang^zlib%gcc@7: '{name}/{version}-libcpp-gcc7'
      boost+clanglibcpp%clang^zlib%gcc@10: '{name}/{version}-libcpp-gcc10'
      boost: '{name}/{version}'
      openblas threads=openmp: '{name}/{version}-openmp'
      openblas threads=pthreads: '{name}/{version}-threaded'
      openblas threads=none: '{name}/{version}-single'
      py-numpy^openblas: 'python-packages/{^python.version}/{name}/.{version}-openblas'
      py-numpy^intel-mkl: 'python-packages/{^python.version}/{name}/.{version}-mkl'
      py-scipy^openblas: 'python-packages/{^python.version}/{name}/.{version}-openblas'
      py-scipy^intel-mkl: 'python-packages/{^python.version}/{name}/.{version}-mkl'
      py-torch^openblas: 'python-packages/{^python.version}/{name}/{version}-openblas'
      py-torch^intel-mkl: 'python-packages/{^python.version}/{name}/{version}-mkl'
      py-disbatch: 'disBatch/{version}'
      python-blas-backend^intel-mkl: 'python/{version}-mkl'
      gromacs+plumed: '{name}/{version}-plumed'
      slurm: 'slurm/current'
      # depend on python, so would be picked up by the python-packages rule unless we do this
      llvm: '{name}/{version}'
      gdb: '{name}/{version}'
      vim: '{name}/{version}'
      mercurial: '{name}/{version}'
      gsl^openblas: '{name}/{version}-openblas'
      gsl^intel-mkl: '{name}/{version}-mkl'
      # python packages
      ^python: 'python-packages/{^python.version}/{name}/{version}'
    python-blas-backend:
      autoload: 'direct'
    py-torch:
      autoload: 'direct'

