modules:
  enable:
    - tcl
    - lmod
  tcl:
    hash_length: 0
    naming_scheme: '{compiler.name}-{compiler.version}/{name}/{version}'
    whitelist:
      - 'py-mpi4py'
      - 'py-numpy'
      - 'py-scipy'
      - 'py-h5py'
      - 'py-pyqt5'
      - 'py-jupyter'
      - 'py-torch'
      - 'python-blas-backend^intel-mkl'
      - 'llvm'
      - 'openmpi'
    blacklist_implicits: true
    blacklist:
      - '%gcc@4.8.5'
      - '^python'
      - 'lmod'
    all:
      autoload: 'none'
      prerequisites: 'direct'
      conflict:
        - '{name}'
      environment:
        set:
          '{name}_BASE': '{prefix}'
      suffixes:
        ^openmpi@1:1: 'openmpi1'
        ^openmpi@2:2: 'openmpi2'
        ^openmpi@4:4: 'openmpi4'
    projections:
      all: '{compiler.name}-{compiler.version}/{name}/{version}'
      openblas threads=openmp: '{compiler.name}-{compiler.version}/{name}/{version}-openmp'
      openblas threads=pthreads: '{compiler.name}-{compiler.version}/{name}/{version}-threaded'
      openblas threads=none: '{compiler.name}-{compiler.version}/{name}/{version}-single'
      llvm: '{compiler.name}-{compiler.version}/{name}/{version}'
      python: '{compiler.name}-{compiler.version}/{name}/{version}'
      python-blas-backend^intel-mkl: '{compiler.name}-{compiler.version}/python/{version}-mkl'
      py-numpy^openblas: '{compiler.name}-{compiler.version}/python-packages/{^python.version}/{name}/.{version}-openblas'
      py-numpy^intel-mkl: '{compiler.name}-{compiler.version}/python-packages/{^python.version}/{name}/.{version}-mkl'
      py-scipy^openblas: '{compiler.name}-{compiler.version}/python-packages/{^python.version}/{name}/.{version}-openblas'
      py-scipy^intel-mkl: '{compiler.name}-{compiler.version}/python-packages/{^python.version}/{name}/.{version}-mkl'
      ^python: '{compiler.name}-{compiler.version}/python-packages/{^python.version}/{name}/{version}'
      gromacs+plumed: '{compiler.name}-{compiler.version}/{name}/{version}-plumed'
      openmpi-opa: '{compiler.name}-{compiler.version}/openmpi/{version}-opa'
      slurm: '{compiler.name}-{compiler.version}/slurm/current'
      gcc: '{name}-{version}/{name}/{version}'
    ^openmpi@4:4:
      prerequisites: 'none'
    intel:
      environment:
        # Hack since it doesn't seem to want to take the license server from file
        set:
          INTEL_LICENSE_FILE: '28518@lic1.flatironinstitute.org'
    py-scipy:
      autoload: 'direct'
    py-numpy:
      autoload: 'direct'
    python-blas-backend:
      autoload: 'direct'
    py-jupyter:
      autoload: 'direct'
    py-h5py:
      prerequisites: 'none'
    py-torch:
      prerequisites: 'none'
    openmpi-opa::
      autoload: 'direct'
      environment:
        set:
          OMPI_MCA_pml: 'cm'
  lmod:
    hierarchy:
      - mpi
    hash_length: 0
    core_compilers:
      - 'gcc@7.4.0'
    core_specs:
      - 'gcc@7.4.0'
      - 'gcc@10.2.0'
    blacklist:
      - '%gcc@4.8.5'
      - '^python'
      - 'lmod'
    blacklist_implicits: true
    openmpi-opa:
      environment:
        set:
          OMPI_MCA_pml: 'cm'
    openmpi:
      environment:
        set:
          'OPENMPI_VERSION': '{version}'
    whitelist:
      - 'py-mpi4py'
      - 'py-numpy'
      - 'py-scipy'
      - 'py-h5py'
      - 'py-pyqt5'
      - 'py-jupyter'
      - 'py-torch'
      - 'python-blas-backend^intel-mkl'
      - 'openmpi'
      - 'llvm'
      - 'gsl'
    all:
      autoload: 'none'
      prerequisites: 'direct'
      environment:
        set:
          '{name}_BASE': '{prefix}'
    matlab:
      environment:
        set:
          'MLM_LICENSE_FILE': '/cm/shared/sw/pkg/vendor/matlab/src/network.lic'
    slurm:
      environment:
        set:
          'CMD_WLM_CLUSTER_NAME': 'slurm'
          'SLURM_CONF': '/cm/shared/apps/slurm/var/etc/slurm/slurm.conf'
    projections:
      openblas threads=openmp: '{name}/{version}-openmp'
      openblas threads=pthreads: '{name}/{version}-threaded'
      openblas threads=none: '{name}/{version}-single'
      llvm: '{name}/{version}'
      py-numpy^openblas: 'python-packages/{^python.version}/{name}/.{version}-openblas'
      py-numpy^intel-mkl: 'python-packages/{^python.version}/{name}/.{version}-mkl'
      py-scipy^openblas: 'python-packages/{^python.version}/{name}/.{version}-openblas'
      py-scipy^intel-mkl: 'python-packages/{^python.version}/{name}/.{version}-mkl'
      py-torch^openblas: 'python-packages/{^python.version}/{name}/{version}-openblas'
      py-torch^intel-mkl: 'python-packages/{^python.version}/{name}/{version}-mkl'
      python-blas-backend^intel-mkl: 'python/{version}-mkl'
      gromacs+plumed: '{name}/{version}-plumed'
      slurm: 'slurm/current'
      ^python: 'python-packages/{^python.version}/{name}/{version}'
    python-blas-backend:
      autoload: 'direct'
    py-torch:
      autoload: 'direct'
