spack:
  config:
    concretizer: clingo
  packages:
    all:
      compiler: [gcc@7.5.0, gcc@10.3.0, intel, clang]
      providers:
        mpi: [openmpi]
        blas: [openblas, intel-mkl]
        lapack: [openblas, intel-mkl]
        scalapack: [openblas, intel-mkl]
    gcc:
      version: [7.5.0, 10.3.0]
    cmake:
      version: [3.18.4]
    ncurses:
      version: [6.2]
    python:
      version: [3.8.10]
    slurm:
      buildable: false
      externals:
      - spec: slurm@20.02.5
        prefix: /cm/shared/apps/slurm/current
    openmpi:
      buildable: false
      externals:
      - spec: openmpi@1.10.7
        prefix: /cm/shared/sw/pkg/devel/openmpi/1.10.7-hfi-slurm17.11
      - spec: openmpi@2.1.6
        prefix: /cm/shared/sw/pkg/devel/openmpi/2.1.6-hfi-slurm18.08
      - spec: openmpi@4.0.5
        prefix: /cm/shared/sw/pkg/devel/openmpi/4.0.5-hfi-slurm18.08
      version: [4.0.5, 2.1.6, 1.10.7]
    mathematica:
      buildable: false
      externals:
      - spec: mathematica@11.2
        prefix: /cm/shared/sw/pkg/vendor/mathematica/11.2
      - spec: mathematica@11.3
        prefix: /cm/shared/sw/pkg/vendor/mathematica/11.3
      - spec: mathematica@12.1
        prefix: /cm/shared/sw/pkg/vendor/mathematica/12.1
      - spec: mathematica@12.2
        prefix: /cm/shared/sw/pkg/vendor/mathematica/12.2
    matlab:
      buildable: false
      externals:
      - spec: matlab@R2018a
        prefix: /cm/shared/sw/pkg/vendor/matlab/R2018a
      - spec: matlab@R2018b
        prefix: /cm/shared/sw/pkg/vendor/matlab/R2018b
      - spec: matlab@R2020a
        prefix: /cm/shared/sw/pkg/vendor/matlab/R2020a
    llvm:
      version: [11.0.1, 10.0.1, 12.0.0]
      variants: +omp_tsan+python
    openblas:
      version: [0.3.15]
      variants: threads=pthreads
    hdf5:
      version: [1.10.7, 1.8.22]
      variants: +hl+fortran+cxx~mpi
    #binutils:
    #  variants: +gold +ld
    cuda:
      version: [11.1.0]
    cudnn:
      version: [8.0.4.30-11.1]
    fftw:
      version: [3.3.9, 2.1.5]
      variants: ~mpi precision=float,double,quad,long_double
  modules:
    default:
      enable:
      - lmod
      lmod:
        hierarchy:
        - mpi
        hash_length: 0
        core_compilers:
        - gcc@7.5.0
        - clang@11.0.1
        core_specs:
        - gcc@7.5.0
        - gcc@10.2.0
        blacklist:
        - '%gcc@4.8.5'
        - ^python
        - lmod
        - openmpi
        blacklist_implicits: true
        openmpi-opa:
          environment:
            set:
              OMPI_MCA_pml: cm
        openmpi:
          environment:
            set:
              OPENMPI_VERSION: '{version}'
        whitelist:
        - py-mpi4py
        - py-numpy
        - py-scipy
        - py-h5py
        - py-pyqt5
        - py-jupyter
        - py-torch
        - py-disbatch
        - python-blas-backend^intel-mkl
        - openmpi%gcc
        - r
        - llvm # things that depend on python, so they get blocked without a whitelist
        - vim
        - gdb
        - cmake
        - mercurial
        - gettext
        - boost
        all:
          autoload: none
          prerequisites: direct
          environment:
            set:
              '{name}_BASE': '{prefix}'
          suffixes:
            ^mpi: mpi
          filter:
            environment_blacklist: [CC, FC, CXX, F77]
        matlab:
          environment:
            set:
              MLM_LICENSE_FILE: /cm/shared/sw/pkg/vendor/matlab/src/network.lic
        slurm:
          environment:
            set:
              CMD_WLM_CLUSTER_NAME: slurm
              SLURM_CONF: /cm/shared/apps/slurm/var/etc/slurm/slurm.conf
        hdf5:
          environment:
            set:
              HDF5_ROOT: '{prefix}'
        boost:
          environment:
            set:
              BOOST_ROOT: '{prefix}'
        projections:
          boost+clanglibcpp%clang^zlib%gcc@7: '{name}/{version}-libcpp-gcc7'
          boost+clanglibcpp%clang^zlib%gcc@10: '{name}/{version}-libcpp-gcc10'
          boost: '{name}/{version}'
          openblas threads=openmp: '{name}/{version}-openmp'
          openblas threads=pthreads: '{name}/{version}-threaded'
          openblas threads=none: '{name}/{version}-single'
          py-numpy^openblas: python-packages/{^python.version}/{name}/.{version}-openblas
          py-numpy^intel-mkl: python-packages/{^python.version}/{name}/.{version}-mkl
          py-scipy^openblas: python-packages/{^python.version}/{name}/.{version}-openblas
          py-scipy^intel-mkl: python-packages/{^python.version}/{name}/.{version}-mkl
          py-torch^openblas: python-packages/{^python.version}/{name}/{version}-openblas
          py-torch^intel-mkl: python-packages/{^python.version}/{name}/{version}-mkl
          py-disbatch: disBatch/{version}
          python-blas-backend^intel-mkl: python/{version}-mkl
          gromacs+plumed: '{name}/{version}-plumed'
          slurm: slurm/current
          llvm: '{name}/{version}' # depend on python, so would be picked up by the python-packages rule unless we do this
          gdb: '{name}/{version}'
          vim: '{name}/{version}'
          mercurial: '{name}/{version}'
          r: '{name}/{version}'
          gsl^openblas: '{name}/{version}-openblas'
          gsl^intel-mkl: '{name}/{version}-mkl'
          ^python: python-packages/{^python.version}/{name}/{version} # python packages
        python-blas-backend:
          autoload: direct
        py-torch:
          autoload: direct
  definitions:
  - compiler:
    - gcc@7.5.0
  - other_compilers:
    - gcc@10.3.0
    #- 'intel'
  - compilers:
    - $compiler
    - $other_compilers
  - mpis:
    - openmpi@1.10.7
    - openmpi@2.1.6
    - openmpi@4.0.5
  - python_blas_packages:
    - py-pandas     # python packages that implicitly depend on blas
    - py-scikit-learn
    - py-numba
    - py-emcee
    - py-astropy
    - py-dask
    - py-seaborn
    - py-matplotlib
  - python_packages:
    - py-cherrypy # python packages that don't depend on blas at all
    - py-flask
    - py-pip
    - py-ipython
    - py-pyyaml
    - py-pylint
    - py-autopep8
    - py-sqlalchemy
    - py-nose
    - py-mako
    - py-pkgconfig
    - py-virtualenv
    - py-sympy
    - py-pycairo
    - py-sphinx
    - py-pytest
    - py-hypothesis
  view: false
  specs:
  - slurm
  - mathematica@11.2
  - mathematica@11.3
  - mathematica@12.1
  - mathematica@12.2
  - matlab@R2018a
  - matlab@R2018b
  - matlab@R2020a
  # Utilities
  - $compilers
  - gcc@11.1.0
  - emacs +X toolkit=athena
  - vim   +x+python+gui+huge+cscope+lua+ruby
  - zsh
  - cmake
  - git
  - gdb # needs python+debug
  - mercurial
  - node-js@:12
  - node-js
  - go
  - rclone
  - subversion
  - tmux
  - valgrind
  - gperftools
  - lftp
  - curl
  - r +X
  # Core libraries
  - matrix:
    - - $%compilers
    - - boost
      - cuda
      - cudnn
      - eigen
      - fftw@:2 precision=float,double
      - fftw
      - gsl+external-cblas ^openblas threads=none
      - gsl+external-cblas ^intel-mkl
      - hdf5@:1.8
      - hdf5
      - intel-mkl
      - intel-oneapi-mkl
      - llvm@10.0.1
      - llvm@11.0.1
      - llvm@12.0.0
      - nfft
      - openblas threads=none
      - openblas threads=openmp
      - openblas threads=pthreads
      - $mpis
      - openmpi-opa@4.0.5
      - python # python default to multithreaded openblas
      - python-blas-backend ^openblas # python-blas-backend is a custom package that includes scipy/numpy
      - python-blas-backend ^intel-mkl
      - $python_packages # all non-blas python packages
      - 'py-pyqt5 ^llvm@11:'
      - 'py-jupyter ^llvm@11:'
      - py-h5py@:2 ~mpi ^openblas
  - boost%clang+clanglibcpp ^bzip2%gcc ^zlib%gcc
  # blas stuff requires a blas spec
  - matrix:
    - - $%compilers
    - - $python_blas_packages
    - - ^openblas
  # Anything dependent on MPI
  - matrix:
    - - $%compiler
    - - $^mpis
    - - hdf5@:1.8+mpi+fortran
      - hdf5+mpi+fortran
      - py-h5py@:2 ^openblas ^hdf5+mpi+fortran
  - matrix:
    - - $%other_compilers
    - - $^mpis
    - - hdf5@:1.8+mpi~fortran
      - hdf5+mpi~fortran
      - py-h5py@:2 ^openblas ^hdf5+mpi~fortran
  - matrix:
    - - $%compilers
    - - $^mpis
    - - boost+mpi
      - fftw@:2
      - fftw
      - py-mpi4py
